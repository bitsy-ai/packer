# bake a nightly image
on:
  # on merge to mainline (packer repo)
  push:
    branches: [ main ]
  # on manual trigger (packer repo) OR workflow_dispatch event from another repo's cd pipeline
  # https://github.community/t/triggering-by-other-repository/16163/6
  workflow_dispatch:
    inputs:
      # begin BASE_IMAGE
      BASE_DISTRO_VERSION:
        description: 'Version string for base distribution, e.g. 2021-05-07-raspios-buster-arm64 or 20211019-02:17-debian-bullseye-arm64'
        required: true
        default: '2021-05-07-raspios-buster-arm64'
      BASE_IMAGE_URL:
        description: 'Bake nightly beginning from this base image'
        required: true
        default: 'https://downloads.raspberrypi.org/raspios_arm64/images/raspios_arm64-2021-05-28/2021-05-07-raspios-buster-arm64.zip'
      BASE_IMAGE_EXT:
        description: 'Base image file format (zip, tar.gz, img)'
        required: true
        default: 'zip'
      BASE_IMAGE_CHECKSUM:
        required: true
        description: 'Checksum for base image'
        default: 'https://downloads.raspberrypi.org/raspios_arm64/images/raspios_arm64-2021-05-28/2021-05-07-raspios-buster-arm64.zip.sha256'
      # end BASE_IMAGE
      # begin app vars
      PRINTNANNY_CLI_VERSION:
        description: 'https://github.com/bitsy-ai/print-nanny-cli/releases'
        required: true
        default: '0.1.2'
      OCTOPRINT_VERSION:
        description: 'https://github.com/OctoPrint/OctoPrint/releases'
        required: true
        default: '1.6.1'
      JANUS_VERSION:
        description: 'https://github.com/meetecho/janus-gateway/releases'
        default: 'v0.11.5'
        required: true
      JANUS_USRSCTP_VERSION:
        description: 'https://github.com/sctplab/usrsctp/releases'
        default: '0.9.5.0'
        required: true
      JANUS_LIBNICE_VERSION:
        description: 'https://gitlab.freedesktop.org/libnice/libnice/-/tags'
        default: '0.1.18'
        required: true
      JANUS_WEBSOCKETS_VERSION:
        description: 'https://libwebsockets.org/git/libwebsockets'
        default: 'v3.2-stable'
        required: true
      RELEASE_CHANNEL:
        description: 'Publish image to release channel: (nightly, stable)'     
        required: true
        default: 'nightly'
    
    
env:
  GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.PACKER_SERVICE_ACCOUNT_KEY }}
  GCP_SERVICE_ACCOUNT: ${{ secrets.PACKER_SERVICE_ACCOUNT }}
  GCP_BUCKET: print-nanny-cdn

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - name: Install platform deps
      run: sudo apt-get install -y jq
    - name: Checkout branch
      uses: actions/checkout@v2
    - name: Write deploy key
      run: echo $GCP_SERVICE_ACCOUNT_KEY > key.json
    - name: Active Service Account
      run: gcloud auth activate-service-account $GCP_SERVICE_ACCOUNT --key-file=key.json
    - name: Make base image
      id: packer
      run: |
        make image \
          BASE_DISTRO_VERSION=${{ inputs.BASE_DISTRO_VERSION }} \
          BASE_IMAGE_CHECKSUM=${{ inputs.BASE_IMAGE_CHECKSUM }} \
          BASE_IMAGE_EXT=${{ inputs.BASE_IMAGE_EXT }} \
          BASE_IMAGE_URL=${{ inputs.BASE_IMAGE_URL }} \
          PRINTNANNY_CLI_VERSION=${{ inputs.PRINTNANNY_CLI_VERSION }} \
          OCTOPRINT_VERSION=${{ inputs.OCTOPRINT_VERSION }} \
          JANUS_VERSION=${{ inputs.JANUS_VERSION }} \
          JANUS_USRSCTP_VERSION=${{ inputs.JANUS_USRSCTP_VERSION }} \
          JANUS_LIBNICE_VERSION=${{ inputs.JANUS_LIBNICE_VERSION }} \
          JANUS_LIBSRTP_VERSION=${{ inputs.JANUS_LIBSRTP_VERSION }} \
          JANUS_WEBSOCKETS_VERSION=${{ inputs.JANUS_WEBSOCKETS_VERSION }} \
          RELEASE_CHANNEL=${{ inputs.RELEASE_CHANN }}
        
        echo ::set-output name=image_path::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.image_path')"
        echo ::set-output name=image_name::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.image_name')"
        echo ::set-output name=checksum::"$(cat dist/sha256.checksum)"
        echo ::set-output name=distro_version::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.distro_version')"
        echo ::set-output name=platform_version::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.platform_version')"
        echo ::set-output name=cpu_arch::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.cpu_arch')"
        echo ::set-output name=printnanny_cli_arch::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.printnanny_cli_arch')"
        echo ::set-output name=octoprint_version::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.octoprint_version')"
        echo ::set-output name=janus_version::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.janus_version')"
        echo ::set-output name=printnanny_cli_version::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.printnanny_cli_version')"
        echo ::set-output name=janus_usrsctp_version::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.janus_usrsctp_version')"
        echo ::set-output name=janus_libnice_version::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.janus_libnice_version')"
        echo ::set-output name=janus_libsrtp_version::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.janus_libsrtp_version')"
        echo ::set-output name=janus_websockets_version::"$(cat dist/manifest.json | jq '.builds[-1].custom_data.janus_websockets_version')"


    - name: Upload to GCP_BUCKET
      run: |
        gsutil rsync -r dist/ gs://$GCP_BUCKET/releases/${{ inputs.RELEASE_CHANNEL }}/${{ steps.packer.outputs.image_path }}/
    - name: Send Discord notification
      env:
        DISCORD_WEBHOOK: ${{ secrets.PRINT_NANNY_DISCORD_DEPLOY_WEBHOOK }}
      uses: Ilshidur/action-discord@master
      with:
        args: |
          Published https://cdn.print-nanny.com/releases/main/${{ steps.packer.outputs.image_path }}/${{ steps.packer.outputs.image_name }}
          Checksum https://cdn.print-nanny.com/releases/main/${{ steps.packer.outputs.image_path }}/sha256.checksum
          Manifest https://cdn.print-nanny.com/releases/main/${{ steps.packer.outputs.image_path }}/manifest.json
          ```
          ${{ steps.packer.outputs.checksum }}
          ------------------------------------
          ${{ inputs }}
          ```