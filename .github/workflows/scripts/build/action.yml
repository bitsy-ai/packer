name: 'Build image'
description: 'Build image from Packer template'
inputs:
  RELEASE_CHANNEL:
    description: 'Publish image to release channel: (nightly, stable)'     
    required: true
    default: 'nightly'
  IMAGE_NAME:
    description: 'Name of image to build'
    required: true
  ANSIBLE_EXTRA_VARS:
    description: 'Path to vars/*.ansiblevars.{yml,json} file to use/generate'
    required: true
  PACKER_VAR_FILE:
    description: 'Path to vars/*.pkrvars.hcl file'
    required: true
  PACKER_TEMPLATE_FILE:
    description: 'Path to templates/*.hcl template to build'
    required: true

outputs:
  artifact:
    description: "Reference to artifact name to be used in subsequent steps"
    value: ${{ inputs.IMAGE_NAME }}-dist
runs:
  using: "composite"
  steps:
  - name: Install Packer
    shell: bash
    run: |
      curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
      sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
      sudo apt-get update && sudo apt-get install packer
  - name: Install Qemu
    shell: bash
    run: |
      sudo apt-get install qemu qemu-user-static binfmt-support
  - name: Init Packer plugins
    shell: bash
    run: |
      sudo make packer-init
  - name: Ensure ansible_extra_vars on disk
    shell: bash
    run: make ${{ inputs.ANSIBLE_EXTRA_VARS }}
  - name: Make image from Packer template
    id: packer
    shell: bash
    run: |
      sudo make packer-build \
        PACKER_VAR_FILE=${{ inputs.PACKER_VAR_FILE}} \
        IMAGE_NAME=${{ inputs.IMAGE_NAME }} \
        PACKER_TEMPLATE_FILE=${{ inputs.PACKER_TEMPLATE_FILE }} \
        ANSIBLE_EXTRA_VARS=${{ inputs.ANSIBLE_EXTRA_VARS }}
      ls -ahl dist/
  - uses: actions/upload-artifact@v2
    with:
      name: ${{ inputs.IMAGE_NAME }}-dist
      path: dist/