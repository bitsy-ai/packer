name: Debian Slim Base
on:
  workflow_dispatch:

env:
  GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.PACKER_SERVICE_ACCOUNT_KEY }}
  GCP_SERVICE_ACCOUNT: ${{ secrets.PACKER_SERVICE_ACCOUNT }}
  GCP_BUCKET: print-nanny-cdn
  CDN_BASE_URL: https://cdn.print-nanny.com

jobs:
##
# begin generic image jobs
##
  build-generic-image:
    strategy:
      fail-fast: false
      matrix:
        os: [  bullseye ]
        arch: [ arm64 ]
        platform: [ debian ]
        include:
          - image_name: raspios-bullseye-slim-arm64
            ansible_extra_vars: vars/generic-pi-arm64.ansiblevars.yml
            packer_vars: vars/raspios-bullseye-slim-arm64.pkrvars.hcl
            packer_template: templates/slim-base.pkr.hcl
            arch: arm64
            os: bullseye
            platform: debian
    outputs:
      artifact: ${{ matrix.image_name }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout branch
      uses: actions/checkout@v2
    - id: base
      uses: ./.github/workflows/scripts/build
      with:
        ANSIBLE_EXTRA_VARS: ${{ matrix.ansible_extra_vars }}
        IMAGE_NAME: ${{ matrix.image_name }}
        PACKER_VAR_FILE: ${{ matrix.packer_vars }}
        PACKER_TEMPLATE_FILE: ${{ matrix.packer_template }}
    - name: Write deploy key
      shell: bash
      run: echo $GCP_SERVICE_ACCOUNT_KEY > key.json
    - name: Activate Service Account
      shell: bash
      run: gcloud auth activate-service-account $GCP_SERVICE_ACCOUNT --key-file=key.json
    - name: Create environment artifacts
      id: packer
      shell: bash
      run: |
        ls dist/
        . dist/${{ matrix.image_name }}.sh
        echo ::set-output name=image_stamp::"$IMAGE_STAMP"
        echo ::set-output name=image_name::"$IMAGE_NAME"
        echo ::set-output name=image_path::"$IMAGE_PATH"
        echo ::set-output name=image_url::"$IMAGE_URL"
        echo ::set-output name=checksum_url::"$CHECKSUM_URL"
        echo ::set-output name=manifest_url::"$MANIFEST_URL"

    - name: Upload to GCP_BUCKET
      shell: bash
      run: |
        gsutil rsync -r dist/ gs://$GCP_BUCKET/${{ steps.packer.outputs.image_path }}/
    - name: Send Discord notification
      env:
        DISCORD_WEBHOOK: ${{ secrets.PRINT_NANNY_DISCORD_DEPLOY_WEBHOOK }}
      uses: Ilshidur/action-discord@master
      with:
        args: |
          ðŸ’œ New image: `${{ steps.packer.outputs.image_stamp }}`
          [Download](${{ steps.packer.outputs.image_url }})
          [Manifest](${{ steps.packer.outputs.manifest_url }})
          [Checksum](${{ steps.packer.outputs.checksum_url }})
